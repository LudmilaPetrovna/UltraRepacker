# УльтраСуперЁбанаОхуенныйРепакер (концепт)

Это что-то среднее между архиватором с максимальной степенью компрессии, инсталлятором и патчером в одном флаконе. Представляет собой 2 основных модуля:
* Упаковщик игры или программы
* Распаковщик-инсталлятор игры или программы

Для работы обоих модулей необходим большой набор инструментов, такие как:

* Кодеки для работы с "обычными" файлами, такими как bmp, jpg, png, wav, mp3
* Кодеки, имеющие самую высокую степень компрессии для своего типа контента (HEVC, FLAC, AAC+)
* Утилиты для работы с "обычными" контейнерами, такими как zip, tar, arj, mp4, avi
* Утилиты для работы с "распакованными данными", такими как obj, x3d, stl, bmp, wav
* Кодеки и утилиты для работы со специализированными контейнерами и сжатыми внутри данными внутри, такими как TXD, FBX, файлы популярных движков, таких как Unity, UE, BASS. Редакторы ресурсов внутри exe/dll.
* Кодеки и утилиты для работы с файлами конкретной игры или программы (различные проприетарные arc, img, pak, dat, map)
* Генераторы различного контента (на манер утилит от .kkrieger, генераторы звуков, текстур), рендереры шрифтов, плееры (рендереры) mp3/mod/midi, синтезаторы речи (text-to-speech)
* Фильтры для контента (нормализаторы звука, изменение яркости текстур, наложение текста или областей для инпентинга, наложение субтитров на видео)

Очевидно, что список выше далеко не полный, да и каждый из уже упомянутых пунктов может расширяться бесконечно. Поэтому, чтобы не превратиться в очередной "универсальный распаковщик ресурсов", все написанное выше - это всего лишь "дорожная карта", но никак не тудушка для немедленного исполнения. Начать можно с реализации всего пары-тройки самых необходимых инструментов. Причем можно взять готовые утилиты, такие как zip/unzip, это совершенно непринципиально иметь все в одном бинарнике (хоть и было бы значительно удобнее).

# Как это работает?

Упаковщик читает директорию с игрой или программой и ищет знакомые себе файлы. К примеру, файлы jpg и bmp. Первые пожаты очень старым алгоритмом компрессии, а вторые - не пожаты вообще (обычно). Если сохранить данные в "традиционный" архив с беспотерьным сжатием, таким как zip, то коэфициент сжатия будет ничтожным. Вместо этого, файлы jpg и bmp можно декодировать, сжать современным кодеком (пусть это будет HEVC) и сохранить в mp4-файл, который положить рядом, а сами оригинальные jpg и bmp в архив не добавлять.

Распаковщик же распаковывает архив как обычно, но найдя "дополнительные" файлы, такие как mp4, распаковывает каждый кадр и пересохраняет их в те самые jpg и bmp, которые были в оригинальной игре или программе. Так как это уже сжатие с потерями, то качество изображений может немного ухудшится, но степень компрессии вырастет на порядки.

Более того, результирующие изображения могут вообще не распаковываться из оригинального архива, а могут быть взяты из дополнительного пользовательского архива, в котором могут содержаться как jpg и bmp с более качественными и перерисованными текстурами - в этом случае инсталлятор просто скопирует их на место, так и mp4 - в этом случае инсталлятор сначала распакует изображения, а потом сконвертирует их в jpg и bmp.

Если же человек, который упаковывает игру или программу, считает эти файлы малозначительными, то упаковщик может еще и предварительно отресайзить эти изображения в 2-4-16 раз, а распаковщик может их апскейлить. Если это какие-то абстрактные текстуры, то упаковщик может просто пометить их как "обычная текстура стены, средняя яркость 123", а распаковщик сгенерирует такую текстуру сам, используя галерею встроенных шейдеров. В этом случае результирующая текстура может быть куда интереснее оригинальной.

Ресайз изображений, равно как и какие-то другие модификации, могут быть выполнены и при распаковке, в зависимости от выбора пользователя. К примеру, если у пользователя недостаточно видеопамяти или его железо не тянет HD-текстурки - логично предложить ему функцию уменьшения текстур, а если пользователь выбрал локализацию - на текстуры могут быть наложены простые надписи, заменяющие собой надписи на текстурах. При этом совершенно не важно, откуда мы берем текстуры и текст-оверлей для них: мы можем взять текстуры из оригинальной игры, а тексты из пользовательского аддона.

Аналогично, при упаковке файлов в формате txd, мы просто удаляем из них промежуточные мипмапы, а при распакове мы не только можем восстановить удаленные мипмапы, но и сгенерировать новые, в еще меньшем разрешении. Это же справедливо для различных картографических наборов, где одна карта представлена множеством слоев, но каждый слой - полная копия предыдущего, только уменшенная в 4 раза.

Если графические ресурсы помещены в какой-то промежуточный контейнер, например, как это делает OSMand с картами-оверлеями, то сначала распаковывается сам контейнер (в случае OSMand это sqlite-база), а далее картинки процессятся как обычно. Распаковщик же сначала распаковывает и ресайзит картинки как обычно, а на выходе упаковывает их sqlite (или другой подходящий) контейнер.

Все это применимо не только к графике, но и к геометрии, звукам, внедренным бинарным данным. К примеру, при распаковке можно сгенерировать озвучку игры при помощи синтезатора речи, если нету озвученной версии на языке пользователя. Или заменить основные модели (LOD 0) на LOD-модели с меньшей детализацией, если у пользователя возникают проблемы с производительностью.

# Rearranger

Проприетарные файлы игровых карт можно конвертировать в png - это позволит их не только сжимать, но и редактировать привычными графическими редакторами, такими как GIMP. Если карты игры небольшие, порядка 32х32 пикселей, то их можно предварительно склеить в большой атлас, что улучшит как степень компрессии, так и упростит редактирование. Собственно, ценность компрессии тут невелика, зато наличие такого распаковщика/упаковщика создаст дополнительную ценность в обществе моддеров и креативно настроенных людей, позволяя легко и просто обмениваться измененными картами игры.

Если графика игры в каком-то проприетарном, неизвестном, но несжатом формате, то области битмапов можно выложить "мозаикой" на 2D-поверхности, разложив остатки данных рядом - весь такой файл можно засунуть в графический редактор и редактировать графику как есть, на живую. Чтобы художник не испортил "мусор", т.е. те самые данные, на мозаику можно добавить текстовые комментарии как по известным сегментам, так и по неизвестным.

### TODO: Написать про автоматический поиск тайлов по куску скриншота, про автоматический подбор палитры, поиск палитры в файле.

# Категория: шизофрения, творчество душевнобольных людей

Я придумал, как охуенно сжимать jpeg-картинки внутри игор и приложений. Создается "как бы обычный файл" с сигнатурой FF D8, можно в него даже записать JFIF заголовок, а потом хуячим в него какой-нибудь APP10, внутри http-ссылка. Декодер должен сам пойти по ссылке и скочать кортинку. Картинка может быть в любом формате, даже в любом разрешении, задача декодера - прожевать это. Внутри архива с игрой только такая вот пустышка. Можно делать HDR. Причем пустышки можно делать из любого формата, просто захукав его декодер в теле игры. Охуенно, не?
